name: CI/CD Pipeline

# Trigger on push to branches containing 'develop' or 'master' in their name
on:
  push:
    branches:
      - '*develop*'
      - '*master*'
  pull_request:
    branches:
      - '*develop*'
      - '*master*'

jobs:
  cross_build:
    name: Cross Platform Build and Test
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            cmake_generator: "Unix Makefiles"
            shell: bash
          - os: macos-latest
            cmake_generator: "Unix Makefiles"
            shell: bash
          - os: windows-latest
            cmake_generator: "Visual Studio 17 2022"
            shell: pwsh
    
    defaults:
      run:
        shell: ${{ matrix.shell }}
    
    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Install CMake (if needed)
      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1.13
        with:
          cmake-version: '3.16'
      
      # Step 3: Install build tools for Windows
      - name: Install build tools (Windows)
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v1.1
      
      # Step 4: Run configuration and building (Unix systems)
      - name: Run CI script (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          # Create build directory
          mkdir -p build
          cd build
          
          # Generate build files with CMake
          cmake .. -G "${{ matrix.cmake_generator }}"
          
          # Build the project
          cmake --build . --config Release
          
          # Run tests
          ctest --output-on-failure -C Release
      
      # Step 4: Run configuration and building (Windows)
      - name: Run CI script (Windows)
        if: matrix.os == 'windows-latest'
        run: ci.bat
      
      # Step 5: Upload build artifacts
      - name: Upload artifacts (Unix)
        if: matrix.os != 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}
          path: |
            build/bin/
          retention-days: 7
      
      # Step 5: Upload build artifacts (Windows)
      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}
          path: |
            build/Release/
            build/Debug/
            build/**/*.exe
          retention-days: 7
      
      # Step 6: Deploy (placeholder - customize as needed)
      - name: Deploy
        run: |
          echo "ðŸš€ Deployment step for ${{ matrix.os }}"
          echo "Build completed successfully on ${{ matrix.os }}"
          echo "Artifacts are ready for deployment"

  # Optional: Create a release if all builds succeed
  create_release:
    name: Create Release
    needs: cross_build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.ref, 'master')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ðŸŽ‰ Automated release from CI/CD pipeline
            
            Built and tested on:
            - âœ… Ubuntu Latest
            - âœ… macOS Latest  
            - âœ… Windows Latest
            
            **Changes in this release:**
            ${{ github.event.head_commit.message }}
          files: |
            build-artifacts-*/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

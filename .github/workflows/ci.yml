name: CI/CD Pipeline

# Trigger on push to branches containing 'develop' or 'master' in their name
on:
  push:
    branches:
      - '*develop*'
      - '*master*'
  pull_request:
    branches:
      - '*develop*'
      - '*master*'

jobs:
  cross_build:
    name: Cross Platform Build and Test
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            cmake_generator: "Unix Makefiles"
            shell: bash
          - os: macos-latest
            cmake_generator: "Unix Makefiles"
            shell: bash
          - os: windows-latest
            cmake_generator: "MinGW Makefiles"
            shell: pwsh
    
    defaults:
      run:
        shell: ${{ matrix.shell }}
    
    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Install CMake (if needed)
      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1.13
        with:
          cmake-version: '3.16'
      
      # Step 3: Install MinGW for Windows
      - name: Install MinGW (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          # Install MinGW for Windows builds
          choco install mingw -y
          
          # Add MinGW to PATH for subsequent steps
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
          # Set up environment variables
          echo "CC=gcc" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CXX=g++" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      
      # Step 4: Verify MinGW installation (Windows)
      - name: Verify MinGW (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          echo "Verifying MinGW installation..."
          gcc --version
          g++ --version
          mingw32-make --version
      
      # Step 5: Run CI build script (Unix systems)
      - name: Run CI script (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          # Create build directory
          mkdir -p build
          cd build
          
          # Generate build files with CMake
          cmake .. -G "${{ matrix.cmake_generator }}"
          
          # Build the project
          cmake --build . --config Release
          
          # Run tests
          ctest --output-on-failure -C Release
      
      # Step 5: Run CI build script (Windows)
      - name: Run CI script (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          # Ensure ci.bat exists
          if (Test-Path "ci.bat") {
            echo "Running ci.bat..."
            .\ci.bat
          } else {
            echo "ci.bat not found! Running fallback CMake build..."
            
            # Create build directory
            New-Item -ItemType Directory -Force -Path build
            Set-Location build
            
            # Configure with MinGW Makefiles
            cmake .. -G "${{ matrix.cmake_generator }}" -DCMAKE_SH="CMAKE_SH-NOTFOUND" -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++
            
            if ($LASTEXITCODE -eq 0) {
              echo "CMake configuration successful!"
              
              # Build the project
              cmake --build . --config Release
              
              # Run tests
              ctest --output-on-failure -C Release
            } else {
              echo "CMake configuration failed!"
              exit 1
            }
          }
      
      # Step 6: List build outputs for debugging
      - name: List build outputs (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          echo "Build directory contents:"
          Get-ChildItem -Path build -Recurse -Include *.exe | ForEach-Object { $_.FullName }
      
      # Step 7: Upload build artifacts (Unix)
      - name: Upload artifacts (Unix)
        if: matrix.os != 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}
          path: |
            build/bin/
            build/**/*.out
            build/**/*.a
            build/**/*.so
            build/**/*.dylib
          retention-days: 7
      
      # Step 7: Upload build artifacts (Windows)
      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}
          path: |
            build/**/*.exe
            build/**/*.dll
            build/**/*.lib
            build/**/*.a
          retention-days: 7
      
      # Step 8: Deploy (placeholder - customize as needed)
      - name: Deploy
        run: |
          echo "ðŸš€ Deployment step for ${{ matrix.os }}"
          echo "Build completed successfully on ${{ matrix.os }}"
          echo "Artifacts are ready for deployment"

  # Optional: Create a release if all builds succeed
  create_release:
    name: Create Release
    needs: cross_build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || contains(github.ref, 'master')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ðŸŽ‰ Automated release from CI/CD pipeline
            
            Built and tested on:
            - âœ… Ubuntu Latest
            - âœ… macOS Latest  
            - âœ… Windows Latest (MinGW)
            
            **Changes in this release:**
            ${{ github.event.head_commit.message }}
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
